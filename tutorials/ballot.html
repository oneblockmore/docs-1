<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Creating a Secret Ballot | Oasis Dev Docs</title>
    <meta name="description" content="Oasis Developer Documentation">
    <link rel="icon" href="/favicon.ico">
  <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-116576458-1"></script>
  <script>window.dataLayer = window.dataLayer || [];
       function gtag(){dataLayer.push(arguments);}
       gtag('js', new Date());
       gtag('config', 'UA-116576458-1');</script>
  <script>var APP_ID = "scny7003";

       window.intercomSettings = {
         app_id: APP_ID
       };

       function intercom(){var w=window;var ic=w.Intercom;if(typeof ic==="function"){ic('reattach_activator');ic('update',w.intercomSettings);}else{var d=document;var i=function(){i.c(arguments);};i.q=[];i.c=function(args){i.q.push(args);};w.Intercom=i;var l=function(){var s=d.createElement('script');s.type='text/javascript';s.async=true;s.src='https://widget.intercom.io/widget/' + APP_ID;var x=d.getElementsByTagName('script')[0];x.parentNode.insertBefore(s,x);};if(w.attachEvent){w.attachEvent('onload',l);}else{w.addEventListener('load',l,false);}}};
       intercom();
      </script>
    
    <link rel="preload" href="/assets/css/0.styles.030c0683.css" as="style"><link rel="preload" href="/assets/js/app.8e9c38f4.js" as="script"><link rel="preload" href="/assets/js/2.a61b10e3.js" as="script"><link rel="preload" href="/assets/js/11.7ac540a6.js" as="script"><link rel="prefetch" href="/assets/js/10.6ae1c52d.js"><link rel="prefetch" href="/assets/js/12.4e8b1c6d.js"><link rel="prefetch" href="/assets/js/13.5dd55cfc.js"><link rel="prefetch" href="/assets/js/3.7eda235d.js"><link rel="prefetch" href="/assets/js/4.bfd67a33.js"><link rel="prefetch" href="/assets/js/5.659af56c.js"><link rel="prefetch" href="/assets/js/6.0fc3ae2b.js"><link rel="prefetch" href="/assets/js/7.5eae073c.js"><link rel="prefetch" href="/assets/js/8.41830117.js"><link rel="prefetch" href="/assets/js/9.3d4e580e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.030c0683.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.svg" alt="Oasis Dev Docs" class="logo"> <span class="site-name can-hide">Oasis Dev Docs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://oasislabs.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Home
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://dashboard.oasiscloud.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Dashboard
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://join.slack.com/t/oasiscommunity/shared_invite/enQtNjQ5MTA3NTgyOTkzLWIxNTg1ZWZmOTIwNmQ2MTg1YmU0MzgyMzk3OWM2ZWQ4NTQ0ZDJkNTBmMTdlM2JhODllYjg5YmJkODc2NzgwNTg" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Forum
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/oasislabs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://oasislabs.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Home
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://dashboard.oasiscloud.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Dashboard
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://join.slack.com/t/oasiscommunity/shared_invite/enQtNjQ5MTA3NTgyOTkzLWIxNTg1ZWZmOTIwNmQ2MTg1YmU0MzgyMzk3OWM2ZWQ4NTQ0ZDJkNTBmMTdlM2JhODllYjg5YmJkODc2NzgwNTg" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Forum
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/oasislabs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/overview.html" class="sidebar-link">Overview</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/overview.html#what-is-oasis" class="sidebar-link">What is Oasis?</a></li><li class="sidebar-sub-header"><a href="/overview.html#cloud-computing-with-blockchain" class="sidebar-link">Cloud Computing with Blockchain</a></li><li class="sidebar-sub-header"><a href="/overview.html#key-features" class="sidebar-link">Key Features</a></li></ul></li><li><a href="/quickstart.html" class="sidebar-link">Quickstart</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/quickstart.html#set-up-the-oasis-sdk" class="sidebar-link">Set Up the Oasis SDK</a></li><li class="sidebar-sub-header"><a href="/quickstart.html#unit-test-the-hello-world-service-using-cargo" class="sidebar-link">Unit Test the &quot;Hello World&quot; Service Using Cargo</a></li><li class="sidebar-sub-header"><a href="/quickstart.html#integration-test-using-the-local-chain" class="sidebar-link">Integration Test Using the Local Chain</a></li><li class="sidebar-sub-header"><a href="/quickstart.html#deploy-on-devnet-2-0" class="sidebar-link">Deploy on Devnet 2.0</a></li><li class="sidebar-sub-header"><a href="/quickstart.html#where-to-go-from-here" class="sidebar-link">Where to go from here?</a></li></ul></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Tutorials</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/tutorials/ballot.html" class="active sidebar-link">Beginner: Secret Ballot</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tutorials/ballot.html#prerequisites" class="sidebar-link">Prerequisites</a></li><li class="sidebar-sub-header"><a href="/tutorials/ballot.html#create-a-new-project" class="sidebar-link">Create a New Project</a></li><li class="sidebar-sub-header"><a href="/tutorials/ballot.html#setting-up-dependencies" class="sidebar-link">Setting up dependencies</a></li><li class="sidebar-sub-header"><a href="/tutorials/ballot.html#defining-the-ballot-service" class="sidebar-link">Defining the Ballot Service</a></li><li class="sidebar-sub-header"><a href="/tutorials/ballot.html#testing" class="sidebar-link">Testing</a></li><li class="sidebar-sub-header"><a href="/tutorials/ballot.html#the-client-side" class="sidebar-link">The Client Side</a></li><li class="sidebar-sub-header"><a href="/tutorials/ballot.html#onward-to-messages-of-victory" class="sidebar-link">Onward to (messages of) victory!</a></li></ul></li><li><a href="/tutorials/messaging.html" class="sidebar-link">Intermediate: Private Chat</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tutorials/messaging.html#prerequisites" class="sidebar-link">Prerequisites</a></li><li class="sidebar-sub-header"><a href="/tutorials/messaging.html#optional-and-user-defined-types" class="sidebar-link">Optional and User-Defined Types</a></li><li class="sidebar-sub-header"><a href="/tutorials/messaging.html#events" class="sidebar-link">Events!</a></li><li class="sidebar-sub-header"><a href="/tutorials/messaging.html#you-made-it" class="sidebar-link">You made it!</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Rust Docs</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Operator Docs</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="creating-a-secret-ballot"><a href="#creating-a-secret-ballot" aria-hidden="true" class="header-anchor">#</a> Creating a Secret Ballot</h1> <p>By now, you should know how to create, build, and test an Oasis service using our CLI.
If you don't, consider (re)visiting our <a href="/quickstart">Quickstart Guide</a>.
Now, we will dive deeper into semantics, learning how to define and implement Oasis service RPCs in Rust.</p> <p>Let's use the motivating example of a voting service that allows participants to fill out a <em>secret ballot</em> to vote for a candidate of their choice.
Because the service runs on the Oasis network, we can be confident that the voting process cannot be rigged and that participants' identity and vote are not revealed either to other participants or to the service itself.</p> <p><strong>tl;dr:</strong> The code for this example can be found <a href="https://github.com/oasislabs/tutorials/tree/master/ballot" target="_blank" rel="noopener noreferrer">here<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h2 id="prerequisites"><a href="#prerequisites" aria-hidden="true" class="header-anchor">#</a> Prerequisites</h2> <p>Building and running this tutorial will require the Oasis CLI.
If you haven't yet installed it, please peruse the <a href="/quickstart">Quickstart guide</a>.</p> <p>Oasis services are currently developed using the Rust programming language. If you are unfamiliar with Rust, the <a href="https://doc.rust-lang.org/nightly/book/" target="_blank" rel="noopener noreferrer">Rust book<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is an excellent place to start.</p> <h2 id="create-a-new-project"><a href="#create-a-new-project" aria-hidden="true" class="header-anchor">#</a> Create a New Project</h2> <p>Now that you've satisfied all the prerequisites, creating your secret ballot application is easy:</p> <div class="language- extra-class"><pre class="language-text"><code>oasis init ballot &amp;&amp; cd ballot
</code></pre></div><p>You should find yourself in a Git repo that has been populated with the following directory structure:</p> <div class="language- extra-class"><pre class="language-text"><code>ballot
│
└───app
│   │   package.json
│   │   tsconfig.json
│   │   tslint.json
│   └───src
│   │   │   index.ts
│   └───test
│   |   │   service.spec.ts
|   └───scripts
|       |   deploy_service.js
└───service
    │   Cargo.toml
    └───src
        │   main.rs
</code></pre></div><p>As you'd expect, <code>service</code> is where your Oasis service(s) will live, while <code>app</code> is for your client to interact with them.</p> <p>Now that you have an overview of your project structure, let's jump right into writing and building your first <code>service</code>.</p> <div class="language- extra-class"><pre class="language-text"><code>cd service
</code></pre></div><p>If you're coming from JavaScript, <code>Cargo.toml</code> is the Rust version of <code>package.json</code> and <code>src/main.rs</code> is akin to <code>index.js</code>.
For more information, the <a href="https://doc.rust-lang.org/nightly/cargo/" target="_blank" rel="noopener noreferrer">Cargo book<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is a fine reference.
The <a href="https://doc.rust-lang.org/nightly/cargo/guide/creating-a-new-project.html" target="_blank" rel="noopener noreferrer">Creating a New Package<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, <a href="https://doc.rust-lang.org/nightly/cargo/guide/dependencies.html" target="_blank" rel="noopener noreferrer">Dependencies<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, and <a href="https://doc.rust-lang.org/nightly/cargo/guide/project-layout.html" target="_blank" rel="noopener noreferrer">Package Layout<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> sections are particularly relevant for this tutorial.</p> <h2 id="setting-up-dependencies"><a href="#setting-up-dependencies" aria-hidden="true" class="header-anchor">#</a> Setting up dependencies</h2> <p>Dependencies are specified in the <em>package manifest</em>: <code>Cargo.toml</code>.
If you open <code>Cargo.toml</code>, you'll see a line at the bottom of the file that says <code>[dependencies]</code>, which is the syntax for a TOML table called dependencies.
Two of the three required dependencies for building your voting service should already be initialized for you by default, and all you need to do is add one for <code>map_vec</code>.
This should make your dependencies look as follows:</p> <div class="language-toml extra-class"><pre class="language-toml"><code><span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span>
<span class="token key property">map_vec</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span> <span class="token key property">version</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.2&quot;</span><span class="token punctuation">,</span> <span class="token key property">features</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">&quot;serde&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
<span class="token key property">oasis-std</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.2&quot;</span>
<span class="token key property">serde</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span> <span class="token key property">version</span> <span class="token punctuation">=</span> <span class="token string">&quot;1.0&quot;</span><span class="token punctuation">,</span> <span class="token key property">features</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">&quot;derive&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
</code></pre></div><p><a href="https://docs.rs/oasis-std" target="_blank" rel="noopener noreferrer"><code>oasis-std</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> contains a collection of types and utilities that make writing blockchain services more pleasant.
<a href="https://serde.rs" target="_blank" rel="noopener noreferrer"><code>serde</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is a SERialization/DEserialization library that's used quite ubiquitously throughout the service and client.
<a href="https://docs.rs/map_vec" target="_blank" rel="noopener noreferrer"><code>map_vec</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> contains <code>Map</code> and <code>Set</code> data structures that trade asymptopic complexity for low constant factors; this tends to be more efficient when writing simple services.
You can use Rust's <code>Hash</code> and <code>BTree</code> variants, if you'd prefer.</p> <p>Those are the only two runtime dependencies that you need to specify.
You'll also want to note the following dev (test) dependency:</p> <div class="language-toml extra-class"><pre class="language-toml"><code><span class="token punctuation">[</span><span class="token table class-name">dev-dependencies</span><span class="token punctuation">]</span>
<span class="token key property">oasis-test</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.2&quot;</span>
</code></pre></div><p><a href="https://docs.rs/oasis-test" target="_blank" rel="noopener noreferrer"><code>oasis-test</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is an in-memory blockchain simulator that you can use to semi-integration test your services before deployment.</p> <h2 id="defining-the-ballot-service"><a href="#defining-the-ballot-service" aria-hidden="true" class="header-anchor">#</a> Defining the Ballot Service</h2> <h3 id="from-cargo-to-cargo-cult"><a href="#from-cargo-to-cargo-cult" aria-hidden="true" class="header-anchor">#</a> From Cargo to Cargo Cult</h3> <p>Let's start with some scaffolding.
If you pop open <code>main.rs</code>, you'll notice that a service named <code>Ballot</code> has already been initialized for you with some bare-bones starter code.
We'll now analyze this service piece-by-piece and extend it to act as the voting service we envision it to be.</p> <p>The top of our Oasis services contain relevant imports. By default, we only have one:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> oasis_std<span class="token punctuation">::</span>Context<span class="token punctuation">;</span>
</code></pre></div><p><a href="https://docs.rs/oasis-std/latest/oasis_std/exe/struct.Context.html" target="_blank" rel="noopener noreferrer"><code>Context</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is a construct that you'll need in mostly every service, and serves as an object that we'll use to keep track of the -- you guessed it -- context of invoked service methods (e.g. the method caller).
Let's also include the <code>Address</code> construct from <code>oasis_std</code>, which we will later use to verify ballot participants' identities, and the <code>map_vec</code> object we decided we needed above. Now we should have two imports:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> map_vec<span class="token punctuation">::</span>Map<span class="token punctuation">;</span>
<span class="token keyword">use</span> oasis_std<span class="token punctuation">::</span><span class="token punctuation">{</span>Address<span class="token punctuation">,</span> Context<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>which covers everything we'll need to use for building our voting service.</p> <h3 id="defining-service-state"><a href="#defining-service-state" aria-hidden="true" class="header-anchor">#</a> Defining service state</h3> <p>The remaining steps to defining a service are 1) deciding what is contained in the state and 2) implementing the RPCs that manipulate that state.</p> <p>The fields of service state are defined in the struct annotated with <code>#[derive(oasis_std::Service)]</code>.
This annotation is a trait which is necessary for handling persisting and loading your service state from platform storage. Currently, though, <code>Ballot</code> is empty and maintains no state:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[derive(oasis_std::Service)]</span>
<span class="token keyword">struct</span> Ballot<span class="token punctuation">;</span>
</code></pre></div><p>Let's fix that, by populating it with a few fields we'll want to keep track of:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[derive(oasis_std::Service)]</span>
<span class="token keyword">struct</span> Ballot <span class="token punctuation">{</span>
    description<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
    candidates<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    tally<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>u32<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    accepting_votes<span class="token punctuation">:</span> bool<span class="token punctuation">,</span>
    admin<span class="token punctuation">:</span> Address<span class="token punctuation">,</span>
    voters<span class="token punctuation">:</span> Map<span class="token operator">&lt;</span>Address<span class="token punctuation">,</span> u32<span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Cool, it looks like a regular ol' struct.
The only thing to keep in mind is that the types must be serializable so that their data can be persisted to storage, but it's okay because <a href="https://serde.rs/data-model.html#types" target="_blank" rel="noopener noreferrer">most of the useful ones are<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.
<code>*Map</code> and <code>*Set</code>? Most certainly.
<code>Vec</code>? Verily!
Simple <code>enum</code>s? Surely!
But references? Risky.
<code>Rc&lt;RefCell&lt;Pin&lt;Box&lt;T&gt;&gt;&gt;&gt;</code>? Not so much.
And of course, pointers: please don't.
Don't worry about remembering these, though.
The compiler will let you know if something won't fly.</p> <p>Great, so that's all there really is to defining service state.</p> <h3 id="defining-service-methods-rpcs"><a href="#defining-service-methods-rpcs" aria-hidden="true" class="header-anchor">#</a> Defining service methods (RPCs)</h3> <p>Like any Rust struct, a service state object can have RPCs attached using an <a href="https://doc.rust-lang.org/std/keyword.impl.html" target="_blank" rel="noopener noreferrer">impl item<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. In our case, all of the RPCs will be defined as public functions inside of an <code>impl Ballot { ... }</code>, which has already been initialized for you. Before we forge ahead with defining the RPCs we want, let's first add a type definition before <code>impl Ballot { ... }</code>:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">type</span> Result<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token operator">=</span> std<span class="token punctuation">::</span>result<span class="token punctuation">::</span>Result<span class="token operator">&lt;</span>T<span class="token punctuation">,</span> String<span class="token operator">&gt;</span><span class="token punctuation">;</span>
</code></pre></div><p><a href="https://doc.rust-lang.org/std/result/" target="_blank" rel="noopener noreferrer">Result<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is a convenient way to propagate errors in your Rust code and/or recover from them in an ergonomic manner. Since all of our RPCs will return values of type <code>std::result::Result&lt;T, String&gt;</code>, this will help make our code a bit less verbose.</p> <h4 id="the-constructor"><a href="#the-constructor" aria-hidden="true" class="header-anchor">#</a> The constructor</h4> <p>All services must have a constructor that returns an instance of the state.
The constructor is called before a service is deployed and initializes the state object.
As in normal Rust parlance, the constructor is <code>new</code>.</p> <p>Here's the constructor for a <code>Ballot</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span>ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Context<span class="token punctuation">,</span> description<span class="token punctuation">:</span> String<span class="token punctuation">,</span> candidates<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
    <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        description<span class="token punctuation">,</span>
        tally<span class="token punctuation">:</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> candidates<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        candidates<span class="token punctuation">,</span>
        accepting_votes<span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">,</span>
        admin<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span><span class="token function">sender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        voters<span class="token punctuation">:</span> Map<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Let's break that down a bit.
First the function signature.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span>ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Context<span class="token punctuation">,</span> description<span class="token punctuation">:</span> String<span class="token punctuation">,</span> candidates<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span>
</code></pre></div><p>The <code>pub</code> is the visibility modifier and denotes that the function is an RPC method.
As we discussed above, <code>ctx: &amp;Context</code> is a reference to a <code>Context</code> object that contains the invoked method context.
<code>description</code> and <code>candidates</code> are <code>String</code> arguments that are passed in by the client.
<code>-&gt; Self</code> denotes that the function returns a <code>Self</code>, and <code>Self</code> is just an alias to the <code>&lt;Thing&gt;</code> in <code>impl &lt;Thing&gt;</code>.
The constructor must return either <code>Self</code> or <code>&lt;Thing&gt;</code>.</p> <h3 id="some-simple-getters"><a href="#some-simple-getters" aria-hidden="true" class="header-anchor">#</a> Some simple getters</h3> <p>It'd probably be helpful if clients could retrieve information like the description of the ballot, the names of the candidates, and whether voting is open? One could even imagine a web app that finds public polls and shows them in a spiffy UI.</p> <p>With this use case in mind, you can replace the existing <code>say_hello</code> example RPC with some methods that return the desired data.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">/// Returns the candidates being voted upon.</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">candidates</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> _ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Context<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Vec<span class="token operator">&lt;</span><span class="token operator">&amp;</span>str<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>candidates<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>String<span class="token punctuation">::</span>as_ref<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/// Returns the description of this ballot.</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">description</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> _ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Context<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span>str <span class="token punctuation">{</span>
    <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>description
<span class="token punctuation">}</span>

<span class="token comment">/// Returns whether voting is still open.</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">voting_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> _ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Context<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> bool <span class="token punctuation">{</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>accepting_votes
<span class="token punctuation">}</span>
</code></pre></div><p>These are similar to the constructor but a bit different. In non-constructor RPC methods, we have access to the state of the service, as provided by a reference to <code>self</code>. We can pick the items out of <code>self</code> that we want and return them to the user. Note that <em>all</em> RPC methods -- even those that do not use <code>self</code> and <code>Context</code> -- receive these two arguments, but you are free to ignore them.</p> <p><em>Note</em>: The first parameter of every RPC must be a <code>Context</code>, and by convention the underscore prefix is used to indicate that it is unused.</p> <h3 id="mutating-state"><a href="#mutating-state" aria-hidden="true" class="header-anchor">#</a> Mutating state</h3> <p>Now to implement the core of the ballot service. We'll want to support functionality for 1) general participants to vote and 2) the ballot owner to close voting.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">/// Cast a vote for a candidate.</span>
<span class="token comment">/// `candidate_num` is the index of the chosen candidate in `self.candidates.`</span>
<span class="token comment">/// You can change your vote as long as the ballot is still open.</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">vote</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Context<span class="token punctuation">,</span> candidate_num<span class="token punctuation">:</span> u32<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token operator">!</span><span class="token keyword">self</span><span class="token punctuation">.</span>accepting_votes <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token string">&quot;Voting is closed.&quot;</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> candidate_num <span class="token keyword">as</span> usize <span class="token operator">&gt;=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>candidates<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token function">format!</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid candidate `{}`.&quot;</span><span class="token punctuation">,</span> candidate_num<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token function">Some</span><span class="token punctuation">(</span>prev_vote<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>voters<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">sender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> candidate_num<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>tally<span class="token punctuation">[</span>prev_vote <span class="token keyword">as</span> usize<span class="token punctuation">]</span> <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>tally<span class="token punctuation">[</span>candidate_num <span class="token keyword">as</span> usize<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/// Closes this ballot so that it no longer collects votes.</span>
<span class="token comment">/// Only the ballot creator can close voting.</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Context<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>admin <span class="token operator">!=</span> ctx<span class="token punctuation">.</span><span class="token function">sender</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token string">&quot;You cannot close the ballot.&quot;</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>accepting_votes <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Again, pretty close to what we've already seen.
<code>pub fn</code>s, <code>Context</code>s, and all that.
If you look closely, you'll see that <code>&amp;self</code> has changed to <code>&amp;mut self</code>, but this is just Rust's way to know that you want a mutable reference to <code>self</code>; it just <em>happens</em> to be the case that modifying <code>self</code> will be persisted to storage.</p> <p>The other new thing here is error handling.
When the service encounters an error condition, it can return an <code>Err</code>. This will revert any pending changes to state and return the error message to the caller. <em>Note</em>: this will eventually change so failure is indicated by panicking with an error message (if you're curious, the reason for this was so the client and service had the same syntax, but it's kind of onerous writing <code>Ok(())</code> everywhere).</p> <p>A-okay, this is starting to look like a ballot service to me!</p> <h3 id="winner-winner"><a href="#winner-winner" aria-hidden="true" class="header-anchor">#</a> Winner, winner!</h3> <p>And what ballot would be complete without a way to tell who got the most votes?
(Other than a rigged ballot, perhaps, but that's why you're using blockchain!)
Let's add two more getters to get vote results:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">/// Returns the index of the candidate with the most votes.</span>
<span class="token comment">/// This method can only be called after voting has closed.</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">winner</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> _ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Context<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Result<span class="token operator">&lt;</span>u32<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>accepting_votes <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token string">&quot;Voting is not closed.&quot;</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token keyword">self</span>
        <span class="token punctuation">.</span>tally
        <span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">max_by_key</span><span class="token punctuation">(</span><span class="token operator">|</span><span class="token punctuation">(</span>_i<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token operator">|</span> <span class="token operator">*</span>v<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token number">0</span> <span class="token keyword">as</span> u32<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/// Returns the number of votes cast for each candidate.</span>
<span class="token comment">/// This method can only be called after voting has closed.</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">results</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> _ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Context<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Result<span class="token operator">&lt;</span>Vec<span class="token operator">&lt;</span>u32<span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>accepting_votes <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token string">&quot;Voting is not closed.&quot;</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>tally<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="testing"><a href="#testing" aria-hidden="true" class="header-anchor">#</a> Testing</h2> <p>Although Rust might sometimes feel like &quot;if it compiles, it works,&quot; it's nice to be able to convince oneself of correctness through tests.
&quot;But I just copied the code you gave me?&quot; say you, the diligent reader.
What? You think tutorial code <em>just works</em>?
What kind of developer experience would that be!
You'd better believe that there's some subtle bug in here somewhere.</p> <p>At the beginning of the tutorial, Cargo generated a bit of test scaffolding at the bottom of your <code>main.rs</code>.
It should look like this:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> tests <span class="token punctuation">{</span>
    <span class="token keyword">extern</span> <span class="token keyword">crate</span> oasis_test<span class="token punctuation">;</span>

    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> sender <span class="token operator">=</span> oasis_test<span class="token punctuation">::</span><span class="token function">create_account</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> ctx <span class="token operator">=</span> Context<span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">with_sender</span><span class="token punctuation">(</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> client <span class="token operator">=</span> Ballot<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">say_hello</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The <a href="https://doc.rust-lang.org/book/ch11-00-testing.html" target="_blank" rel="noopener noreferrer">Rust book<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, as ever, will tell you all you need to know about <code>#[cfg(test)]</code>, <code>#[test]</code>, and the like.
For our purposes, we'll want to replace the generated code with the following chunk.
I promise that this isn't where the bug is.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> tests <span class="token punctuation">{</span>
    <span class="token comment">// This is required even in Rust 2018.</span>
    <span class="token comment">// If omitted, rustc will not link in the testing</span>
    <span class="token comment">// library and will produce a giant error message.</span>
    <span class="token keyword">extern</span> <span class="token keyword">crate</span> oasis_test<span class="token punctuation">;</span>

    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>

    <span class="token comment">/// Creates a new account and a Context with the new account as the sender.</span>
    <span class="token keyword">fn</span> <span class="token function">create_account_ctx</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token punctuation">(</span>Address<span class="token punctuation">,</span> Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> addr <span class="token operator">=</span> oasis_test<span class="token punctuation">::</span><span class="token function">create_account</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token comment">/* initial balance */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> ctx <span class="token operator">=</span> Context<span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">with_sender</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">with_gas</span><span class="token punctuation">(</span><span class="token number">100_000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span>addr<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function">functionality</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token punctuation">(</span>_admin<span class="token punctuation">,</span> admin_ctx<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">create_account_ctx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token punctuation">(</span>_voter<span class="token punctuation">,</span> voter_ctx<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">create_account_ctx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> description <span class="token operator">=</span> <span class="token string">&quot;What's for dinner?&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> candidates <span class="token operator">=</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token string">&quot;beef&quot;</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;yogurt&quot;</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> ballot <span class="token operator">=</span>
            Ballot<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>admin_ctx<span class="token punctuation">,</span> description<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> candidates<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">assert_eq!</span><span class="token punctuation">(</span>ballot<span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>admin_ctx<span class="token punctuation">)</span><span class="token punctuation">,</span> description<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assert_eq!</span><span class="token punctuation">(</span>ballot<span class="token punctuation">.</span><span class="token function">candidates</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>admin_ctx<span class="token punctuation">)</span><span class="token punctuation">,</span> candidates<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assert_eq!</span><span class="token punctuation">(</span>ballot<span class="token punctuation">.</span><span class="token function">voting_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>admin_ctx<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Can't get winner before voting has closed.</span>
        <span class="token function">assert!</span><span class="token punctuation">(</span>ballot<span class="token punctuation">.</span><span class="token function">winner</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>voter_ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        ballot<span class="token punctuation">.</span><span class="token function">vote</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>voter_ctx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ballot<span class="token punctuation">.</span><span class="token function">vote</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>voter_ctx<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ballot<span class="token punctuation">.</span><span class="token function">vote</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>admin_ctx<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Non-admin can't close ballot.</span>
        ballot<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>voter_ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ballot<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>admin_ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Votes can't be cast after ballot has closed.</span>
        ballot<span class="token punctuation">.</span><span class="token function">vote</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>admin_ctx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">assert_eq!</span><span class="token punctuation">(</span>ballot<span class="token punctuation">.</span><span class="token function">voting_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>voter_ctx<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assert_eq!</span><span class="token punctuation">(</span>ballot<span class="token punctuation">.</span><span class="token function">winner</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>voter_ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assert_eq!</span><span class="token punctuation">(</span>ballot<span class="token punctuation">.</span><span class="token function">results</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>voter_ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>There are two things to note here.
The first is that, when external to the service (i.e. not in <code>impl Ballot { ... }</code>), <code>Ballot</code> refers to the service client which can deploy and/or interact with a deployed service.
The other is that you can create your own <code>Context</code> to pass to the service RPCs.
When testing, you can explicitly set the <code>sender</code> (the method invoker), but this will be your account when deploying in production.
Testing accounts are created using <code>oasis_test::create_account</code>.</p> <p>You can now run the test using <code>oasis test</code>.
(Protip: use <code>oasis test -- --nocapture</code> to pass through stdout and stderr.)
This will run your tests using the blockchain simulator in <code>oasis-test</code>.
If all goes well, you should see your test pass.
Okay, so maybe there was no bug, but at least you now know how to test your service!</p> <h3 id="building-for-deployment"><a href="#building-for-deployment" aria-hidden="true" class="header-anchor">#</a> Building for deployment</h3> <p>Finally, it's time to ready your service for deployment. You'll notice the following block that's been initialized for you in your <code>Ballot</code> service:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    oasis_std<span class="token punctuation">::</span><span class="token function">service!</span><span class="token punctuation">(</span>Ballot<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This Rust macro automatically builds your service when you run <code>oasis build</code> from within <code>service</code> and creates a deployable Wasm service for you in <code>target/service/ballot.wasm</code>.
You can now use this service in the same manner as our quickstart guide, by <a href="https://docs.oasis.dev/quickstart.html#integration-test-using-the-local-chain" target="_blank" rel="noopener noreferrer">running
a deploy test with our client<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>If you're feeling more adventurous and want to see how to build out the frontend for your application, forge onwards to the next section. Otherwise, feel free to <a href="#onward-to-messages-of-victory">skip ahead</a>.</p> <h2 id="the-client-side"><a href="#the-client-side" aria-hidden="true" class="header-anchor">#</a> The Client Side</h2> <p>Ok, so now you have an Oasis service built and ready to deploy.
How can you turn this into a living, breathing application with which your users can interact?
Rather than walk you through building a fancy frontend, we're just going to give you one and show you how it interacts with your service:</p> <ol><li>Clone our tutorials repo to the destination of your choice<div class="language- extra-class"><pre class="language-text"><code>git clone https://github.com/oasislabs/tutorials.git &lt;destination&gt;
</code></pre></div></li> <li>Get rid of the existing starter code application, and replace it with the one from our tutorial:<div class="language- extra-class"><pre class="language-text"><code>rm -rf app &amp;&amp; cp -r &lt;destination&gt;/tutorials/ballot/app app
</code></pre></div></li></ol> <p>Nice! This pre-baked application is written in <a href="https://vuejs.org/" target="_blank" rel="noopener noreferrer">Vue.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, but the concepts we're about to discuss should largely be generalizable to your web framework of choice as well.
Let's inspect the contents of the application source code:</p> <div class="language- extra-class"><pre class="language-text"><code>cd app &amp;&amp; ls src
</code></pre></div><p>which should reveal the following file structure:</p> <div class="language- extra-class"><pre class="language-text"><code>App.vue
main.js
router.js
store.js
plugins/
views/
</code></pre></div><p><code>App.vue</code>, <code>main.js</code>, and <code>plugins/</code> are used for defining application structure and initialization; <code>views/</code> stores the different pages within your applications; and <code>router.js</code> stores routing information for navigating between those views.
We won't focus on any of these for the most part, and restrict our attention to <code>store.js</code>.</p> <h3 id="local-state-management"><a href="#local-state-management" aria-hidden="true" class="header-anchor">#</a> Local State Management</h3> <p>When you open <code>store.js</code>, you'll notice the initial configuration:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Vuex <span class="token keyword">from</span> <span class="token string">'vuex'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> oasis <span class="token keyword">from</span> <span class="token string">'@oasislabs/client'</span><span class="token punctuation">;</span>

Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Vuex<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><a href="https://vuex.vuejs.org/" target="_blank" rel="noopener noreferrer">Vuex<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is the state management library for Vue, which makes it simple to store and predictably mutate your global application state.
This is the bottleneck location where all logic for connecting to and making RPCs to your ballot service will be implemented.</p> <p>As best practice, even with other frameworks we recommend you create a single instance of every Oasis service your application interacts with, and isolate all service interaction within whatever your web framework uses as a global state container (i.e. <code>vuex</code> for Vue.js and <code>redux</code> for React).</p> <p>Cool. Next let's turn our attention to the store initialization; you'll notice we <code>export default new Vuex.Store(&lt;store&gt;);</code>, where <code>&lt;store&gt;</code> is a Javascript object containing <code>state</code>, <code>mutations</code>, and <code>actions</code> as attributes.</p> <p>In summary, <code>state</code> stores global application state and <code>actions</code> are methods which asynchronously modify that state by commiting synchronous <code>mutations</code>. If you're curious to learn more, check out <a href="https://vuex.vuejs.org/guide/state.html" target="_blank" rel="noopener noreferrer">these awesome Vue docs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>!</p> <h4 id="state"><a href="#state" aria-hidden="true" class="header-anchor">#</a> State</h4> <p>For state, we'll keep track of the constructor <code>args</code> to our secret ballot, a filepath to the generated service <code>bytecode</code>, a pointer to a locally-running <code>gateway</code> for submitting RPCs (which we'll set up shortly), and a <code>mnemonic</code> which is used by the gateway to sign RPCs and validate them as having been initiated by you.
All of these will be used to create the <code>ballot</code> object in your state, which is a nice abstraction that represents your ballot service and will let you make RPCs painlessly.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>state<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    args<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token string">'Which starter Pokemon is the best?'</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span>
            <span class="token string">'Bulbasaur'</span><span class="token punctuation">,</span>
            <span class="token string">'Charmander'</span><span class="token punctuation">,</span>
            <span class="token string">'Squirtle'</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    ballot<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    bytecode<span class="token punctuation">:</span> <span class="token string">'/assets/ballot.wasm'</span><span class="token punctuation">,</span>
    gateway<span class="token punctuation">:</span> <span class="token string">'https://gateway.devnet.oasiscloud.io'</span><span class="token punctuation">,</span>
    token<span class="token punctuation">:</span> <span class="token string">'AAAAAhq2tOs8hDVZLUob7LDnb1SsBS2ZGV3zIguKznK5jv/J'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="mutations"><a href="#mutations" aria-hidden="true" class="header-anchor">#</a> Mutations</h4> <p>We only need a single mutation, used for committing the (initially null) <code>ballot</code> in your state to the actual service reference once it's initialized.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>mutations<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token function">setBallot</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> ballot</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        state<span class="token punctuation">.</span>ballot <span class="token operator">=</span> ballot<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="actions"><a href="#actions" aria-hidden="true" class="header-anchor">#</a> Actions</h4> <p>These first few actions are where all the heavy lifting happens. <code>connectToOasis()</code> configures your gateway so it's ready to sign off on RPCs you initiate.
<code>deployService()</code> and <code>loadService()</code> can then be used to either create a new service instance (by reading in bytecode from <code>ballot.wasm</code> and deploying it via the <code>gateway</code>) or connecting to an existing one, respectively.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Ballot Instantiation</span>
<span class="token keyword">async</span> <span class="token function">connectToOasis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> headers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    headers<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'X-OASIS-LOGIN-TOKEN'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    headers<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'X-OASIS-SESSION-KEY'</span><span class="token punctuation">,</span> <span class="token string">'ballot-session'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> gateway <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">oasis<span class="token punctuation">.</span>gateways<span class="token punctuation">.</span>Gateway</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>gateway<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> headers <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    oasis<span class="token punctuation">.</span><span class="token function">setGateway</span><span class="token punctuation">(</span>gateway<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token keyword">async</span> <span class="token function">deployService</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> commit <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'connectToOasis'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Read the bytecode stored in ballot.wasm</span>
    <span class="token keyword">const</span> bytecode <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>bytecode<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=&gt;</span> response<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">stream</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> serviceBinary <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">arrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>serviceBinary<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Deploy your service with the Oasis client</span>
    <span class="token keyword">const</span> ballot <span class="token operator">=</span> <span class="token keyword">await</span> oasis<span class="token punctuation">.</span><span class="token function">deploy</span><span class="token punctuation">(</span><span class="token operator">...</span>this<span class="token punctuation">.</span>state<span class="token punctuation">.</span>args<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        bytecode<span class="token punctuation">,</span>
        options<span class="token punctuation">:</span> <span class="token punctuation">{</span> gasLimit<span class="token punctuation">:</span> <span class="token string">'0xf42400'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'setBallot'</span><span class="token punctuation">,</span> ballot<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token keyword">async</span> <span class="token function">loadService</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> commit <span class="token punctuation">}</span><span class="token punctuation">,</span> address</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'connectToOasis'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> ballot <span class="token operator">=</span> <span class="token keyword">await</span> oasis<span class="token punctuation">.</span>Service<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'setBallot'</span><span class="token punctuation">,</span> ballot<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Finally, we have a number of actions specifically for executing RPCs.
As you'll notice, once your ballot instance is initialized this is as simple as calling the RPC name from your service instance.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Ballot API</span>
<span class="token keyword">async</span> <span class="token function">castVote</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>_<span class="token punctuation">}</span><span class="token punctuation">,</span> candidateNum</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>ballot<span class="token punctuation">.</span><span class="token function">vote</span><span class="token punctuation">(</span>candidateNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token keyword">async</span> <span class="token function">closeBallot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>ballot<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token keyword">async</span> <span class="token function">getBallotID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>ballot<span class="token punctuation">.</span>_inner<span class="token punctuation">.</span>address<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token keyword">async</span> <span class="token function">getCandidates</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>ballot<span class="token punctuation">.</span><span class="token function">candidates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token keyword">async</span> <span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>ballot<span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token keyword">async</span> <span class="token function">getOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>ballot<span class="token punctuation">.</span><span class="token function">votingOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token keyword">async</span> <span class="token function">getResults</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>ballot<span class="token punctuation">.</span><span class="token function">results</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token keyword">async</span> <span class="token function">getWinner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>ballot<span class="token punctuation">.</span><span class="token function">winner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><h3 id="running-the-application"><a href="#running-the-application" aria-hidden="true" class="header-anchor">#</a> Running the application</h3> <p>Perfect! Now that you know how to interact with your service via your application, let's try it out.
Simply run <code>oasis chain</code> to spin up your local blockchain server, then in another terminal window, run</p> <div class="language- extra-class"><pre class="language-text"><code>npm install
npm run serve
</code></pre></div><p>and the voting application should spin itself up, yielding output that looks like the following:</p> <div class="language- extra-class"><pre class="language-text"><code>App running at:
  - Local:   http://localhost:8080/ 
  - Network: http://192.168.222.173:8080/
</code></pre></div><p>Voila! A working voting application, accessible at <code>http://localhost:8080</code>.
You'll see it load for a couple of seconds as your service is deployed using the <code>deployService()</code> action, then a <code>Participate in Vote</code> button should appear and your service ID will be displayed as a query parameter in the address bar.
At long last, you can rest easy, appreciating the deep euphoria of having built a fully-functional decentralized cloud service and application.</p> <p>After interacting with the app and voting, checking your <code>oasis chain</code> terminal window should be populated with logs, including those for all service RPCs you made during your interactions.</p> <h2 id="onward-to-messages-of-victory"><a href="#onward-to-messages-of-victory" aria-hidden="true" class="header-anchor">#</a> Onward to (messages of) victory!</h2> <p>Congratulations on completing the first tutorial!
You can now imagine that you could hold elections on dinner, your fantasy sportsball team, or the supreme ruler of your digital nation state (digital nation state not included).</p> <p>Up next is a confidential message board service that demonstrates more advanced concepts like events and custom types.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/oasislabs/docs/edit/master/src/tutorials/ballot.md" target="_blank" rel="noopener noreferrer">Help us improve this page!</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/quickstart.html" class="prev">Quickstart</a></span> <span class="next"><a href="/tutorials/messaging.html">Intermediate: Private Chat</a>→
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.8e9c38f4.js" defer></script><script src="/assets/js/2.a61b10e3.js" defer></script><script src="/assets/js/11.7ac540a6.js" defer></script>
  </body>
</html>
